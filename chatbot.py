# -*- coding: utf-8 -*-
"""Untitled4.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1P0vRaH6mqLhVzXnqAelIC0u0AJiwtaM6
"""

import numpy as np
from sklearn.metrics.pairwise import cosine_similarity
# converting the user query unto vectors
def get_embedding(text):
    return transformer_model.encode(text)

# finding the most similar answer
def find_best_answer(question, history):
    question_embedding = get_embedding(question)
    best_similarity = 0
    best_answer = "Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø£Ù…Ø± Ø±Ø§Ø¬Ø¹ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø´Ø§ÙŠØ® Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠÙ†."

    for item in embeddings:
        similarity = cosine_similarity([question_embedding], [item['embedding']])[0][0]
        if similarity > best_similarity:
            best_similarity = similarity
            best_answer = item['metadata'].get("answer") or item['metadata'].get("content") or item['text'] or best_answer

    # if the similarity rate less than 75%, the question is not in the range of ansewrs
    if best_similarity < 0.75:
        best_answer = "Ø¹Ø°Ø±Ù‹Ø§ØŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø£Ù„Ø© Ø±Ø§Ø¬Ø¹ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø´Ø§ÙŠØ® Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠÙ†."

    # updating history
    history.append((question, best_answer))
    return best_answer, history

# creating Gradio graphical interface
with gr.Blocks() as demo:
    gr.Markdown("### Ø´Ø§Øª Ø¨ÙˆØª Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù† Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø´Ø±Ø¹ÙŠØ© Ù„Ù„ØµÙ„Ø§Ø©")
    gr.Markdown("ðŸ’¡ ØªØ­Ø°ÙŠØ± Ù‡Ø°Ø§Ø§Ù„Ø´Ø§Øª Ø¨ÙˆØª Ù„Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©, Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø£Ø­ÙƒØ§Ù… Ø§Ù„Ø´Ø±Ø¹ÙŠØ© Ø§Ø³Ø£Ù„ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø´Ø§ÙŠØ® Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ÙŠÙ†, Ù‚Ø§Ù„ ØªØ¹Ø§Ù„Ù‰: (ÙØ§Ø³Ø£Ù„ÙˆØ§ Ø£Ù‡Ù„ Ø§Ù„Ø°ÙƒØ± Ø¥Ù† ÙƒÙ†ØªÙ… Ù„Ø§ØªØ¹Ù„Ù…ÙˆÙ†)!")
    chat_history = gr.State([])
    with gr.Row():
        with gr.Column():
            question = gr.Textbox(placeholder="Ø§Ø³Ø£Ù„Ù†ÙŠ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¹Ù† Ø£Ø­ÙƒØ§Ù… Ø§Ù„ØµÙ„Ø§Ø© ...")
            send_button = gr.Button("Ø¥Ø±Ø³Ø§Ù„")
        with gr.Column():
            answer = gr.Textbox(interactive=False)

    send_button.click(fn=find_best_answer, inputs=[question, chat_history], outputs=[answer, chat_history])

# running the app
demo.launch(share=True)